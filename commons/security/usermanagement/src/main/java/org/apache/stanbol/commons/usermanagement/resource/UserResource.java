begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|commons
operator|.
name|usermanagement
operator|.
name|resource
package|;
end_package

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|jersey
operator|.
name|multipart
operator|.
name|FormDataParam
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|locks
operator|.
name|Lock
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|Consumes
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|DefaultValue
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|FormParam
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|GET
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|POST
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|PathParam
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|Produces
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|QueryParam
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|WebApplicationException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|CacheControl
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|Context
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|MediaType
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|Response
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|UriBuilder
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|ws
operator|.
name|rs
operator|.
name|core
operator|.
name|UriInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|platform
operator|.
name|config
operator|.
name|SystemConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|BNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|Graph
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|Literal
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|MGraph
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|NonLiteral
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|PlainLiteral
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|Triple
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|TripleCollection
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|UriRef
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|access
operator|.
name|LockableMGraph
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|impl
operator|.
name|PlainLiteralImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|impl
operator|.
name|SimpleGraph
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|impl
operator|.
name|SimpleMGraph
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|impl
operator|.
name|TripleImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|serializedform
operator|.
name|Parser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|serializedform
operator|.
name|Serializer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|core
operator|.
name|serializedform
operator|.
name|SupportedFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|ontologies
operator|.
name|DC
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|ontologies
operator|.
name|FOAF
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|ontologies
operator|.
name|PERMISSION
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|ontologies
operator|.
name|PLATFORM
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|ontologies
operator|.
name|RDF
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|ontologies
operator|.
name|SIOC
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|utils
operator|.
name|GraphNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|utils
operator|.
name|MGraphUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|clerezza
operator|.
name|rdf
operator|.
name|utils
operator|.
name|MGraphUtils
operator|.
name|NoSuchSubGraphException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Component
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Reference
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Service
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|commons
operator|.
name|security
operator|.
name|PasswordUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|commons
operator|.
name|usermanagement
operator|.
name|Ontology
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|commons
operator|.
name|web
operator|.
name|viewable
operator|.
name|RdfViewable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_class
annotation|@
name|Component
annotation|@
name|Service
argument_list|(
name|UserResource
operator|.
name|class
argument_list|)
annotation|@
name|Path
argument_list|(
literal|"user-management"
argument_list|)
specifier|public
class|class
name|UserResource
block|{
specifier|private
specifier|static
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|UserResource
operator|.
name|class
argument_list|)
decl_stmt|;
annotation|@
name|Reference
argument_list|(
name|target
operator|=
name|SystemConfig
operator|.
name|SYSTEM_GRAPH_FILTER
argument_list|)
specifier|private
name|LockableMGraph
name|systemGraph
decl_stmt|;
annotation|@
name|Reference
specifier|private
name|Parser
name|parser
decl_stmt|;
annotation|@
name|Reference
specifier|private
name|Serializer
name|serializer
decl_stmt|;
specifier|private
specifier|static
name|GraphNode
name|dummyNode
decl_stmt|;
static|static
block|{
name|dummyNode
operator|=
operator|new
name|GraphNode
argument_list|(
operator|new
name|BNode
argument_list|()
argument_list|,
operator|new
name|SimpleMGraph
argument_list|()
argument_list|)
expr_stmt|;
name|dummyNode
operator|.
name|addProperty
argument_list|(
name|RDF
operator|.
name|type
argument_list|,
name|FOAF
operator|.
name|Agent
argument_list|)
expr_stmt|;
block|}
comment|// **********************************
comment|// ****** SHOW USER DETAILS ******
comment|// **********************************
comment|/**      * lookup a user by name.      *      * @param userName      * @return      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"view-user"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|RdfViewable
name|viewUser
parameter_list|(
annotation|@
name|QueryParam
argument_list|(
literal|"userName"
argument_list|)
name|String
name|userName
parameter_list|)
block|{
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"edit"
argument_list|,
name|getUser
argument_list|(
name|userName
argument_list|)
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * lookup a user by name presenting it with "editUser" as rendering      * instruction.      *      * @param userName      * @return      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"user/{username}"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|RdfViewable
name|editUser
parameter_list|(
annotation|@
name|PathParam
argument_list|(
literal|"username"
argument_list|)
name|String
name|userName
parameter_list|)
block|{
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"editUser"
argument_list|,
name|getUser
argument_list|(
name|userName
argument_list|)
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * Produces suitable permission-checkboxes      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"user/{username}/permissionsCheckboxes"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|RdfViewable
name|permissionsCheckboxes
parameter_list|(
annotation|@
name|PathParam
argument_list|(
literal|"username"
argument_list|)
name|String
name|userName
parameter_list|)
block|{
comment|//getUser(userName)
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"permissionsCheckboxes"
argument_list|,
name|getUser
argument_list|(
name|userName
argument_list|)
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * RESTful access to individual user data [has integration test]      *      * @param userName      * @return context graph for user      * @throws UnsupportedEncodingException      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"users/{username}"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
specifier|public
name|Response
name|getUserTurtle
parameter_list|(
annotation|@
name|PathParam
argument_list|(
literal|"username"
argument_list|)
name|String
name|userName
parameter_list|)
throws|throws
name|UnsupportedEncodingException
block|{
name|ByteArrayOutputStream
name|baos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|serializer
operator|.
name|serialize
argument_list|(
name|baos
argument_list|,
name|getUser
argument_list|(
name|userName
argument_list|)
operator|.
name|getNodeContext
argument_list|()
argument_list|,
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
expr_stmt|;
name|String
name|serialized
init|=
operator|new
name|String
argument_list|(
name|baos
operator|.
name|toByteArray
argument_list|()
argument_list|,
literal|"utf-8"
argument_list|)
decl_stmt|;
comment|// System.out.println("User = "+serialized);
return|return
name|Response
operator|.
name|ok
argument_list|(
name|serialized
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**      * RESTful access to user roles (and permissions right now - may change)      * [has integration test]      *      * @param userName      * @return context graph for user      * @throws UnsupportedEncodingException      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"roles/{username}"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
specifier|public
name|Response
name|getUserRoles
parameter_list|(
annotation|@
name|PathParam
argument_list|(
literal|"username"
argument_list|)
name|String
name|userName
parameter_list|)
throws|throws
name|UnsupportedEncodingException
block|{
name|ByteArrayOutputStream
name|baos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|MGraph
name|rolesGraph
init|=
name|getUserRolesGraph
argument_list|(
name|userName
argument_list|)
decl_stmt|;
comment|// case of no roles not handled - what best to return : empty graph or
comment|// 404?
name|serializer
operator|.
name|serialize
argument_list|(
name|baos
argument_list|,
name|rolesGraph
argument_list|,
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
expr_stmt|;
name|String
name|serialized
init|=
operator|new
name|String
argument_list|(
name|baos
operator|.
name|toByteArray
argument_list|()
argument_list|,
literal|"utf-8"
argument_list|)
decl_stmt|;
return|return
name|Response
operator|.
name|ok
argument_list|(
name|serialized
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**      * Update user details.      *      * @param uriInfo      * @param currentLogin      * @param newLogin      * @param fullName      * @param email      * @param password      * @param roles      * @param permissions      * @return      */
annotation|@
name|POST
annotation|@
name|Path
argument_list|(
literal|"store-user"
argument_list|)
comment|// @Consumes("multipart/form-data")
annotation|@
name|Consumes
argument_list|(
name|MediaType
operator|.
name|APPLICATION_FORM_URLENCODED
argument_list|)
specifier|public
name|Response
name|storeUser
parameter_list|(
annotation|@
name|Context
name|UriInfo
name|uriInfo
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"currentLogin"
argument_list|)
name|String
name|currentLogin
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"newLogin"
argument_list|)
name|String
name|newLogin
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"fullName"
argument_list|)
name|String
name|fullName
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"email"
argument_list|)
name|String
name|email
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"password"
argument_list|)
name|String
name|password
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"roles"
argument_list|)
name|List
argument_list|<
name|String
argument_list|>
name|roles
parameter_list|,
annotation|@
name|FormParam
argument_list|(
literal|"permissions"
argument_list|)
name|List
argument_list|<
name|String
argument_list|>
name|permissions
parameter_list|)
block|{
name|GraphNode
name|userNode
decl_stmt|;
if|if
condition|(
name|currentLogin
operator|!=
literal|null
condition|)
block|{
comment|//
name|currentLogin
operator|=
name|currentLogin
operator|.
name|trim
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|currentLogin
operator|!=
literal|null
operator|&&
operator|!
name|currentLogin
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|userNode
operator|=
name|getUser
argument_list|(
name|currentLogin
argument_list|)
expr_stmt|;
return|return
name|store
argument_list|(
name|userNode
argument_list|,
name|uriInfo
argument_list|,
name|currentLogin
argument_list|,
name|newLogin
argument_list|,
name|fullName
argument_list|,
name|email
argument_list|,
name|password
argument_list|,
name|roles
argument_list|,
name|permissions
argument_list|)
return|;
block|}
name|userNode
operator|=
name|createUser
argument_list|(
name|newLogin
argument_list|)
expr_stmt|;
return|return
name|store
argument_list|(
name|userNode
argument_list|,
name|uriInfo
argument_list|,
name|newLogin
argument_list|,
name|newLogin
argument_list|,
name|fullName
argument_list|,
name|email
argument_list|,
name|password
argument_list|,
name|roles
argument_list|,
name|permissions
argument_list|)
return|;
block|}
comment|/**      * produces suitable role checkboxes      *      * @return      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"rolesCheckboxes"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|SupportedFormat
operator|.
name|HTML
argument_list|)
specifier|public
name|RdfViewable
name|rolesCheckboxes
parameter_list|()
block|{
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"rolesCheckboxes"
argument_list|,
name|getRoleType
argument_list|()
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|/*      * Modify user given give a graph describing the change.      */
annotation|@
name|POST
annotation|@
name|Consumes
argument_list|(
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
annotation|@
name|Path
argument_list|(
literal|"change-user"
argument_list|)
specifier|public
name|Response
name|changeUser
parameter_list|(
name|String
name|userData
parameter_list|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"changeUser called with "
operator|+
name|userData
argument_list|)
expr_stmt|;
name|Graph
name|inputGraph
init|=
name|readData
argument_list|(
name|userData
argument_list|)
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|changes
init|=
name|inputGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|Ontology
operator|.
name|Change
argument_list|)
decl_stmt|;
while|while
condition|(
name|changes
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|changeTriple
init|=
name|changes
operator|.
name|next
argument_list|()
decl_stmt|;
name|NonLiteral
name|changeNode
init|=
name|changeTriple
operator|.
name|getSubject
argument_list|()
decl_stmt|;
name|Literal
name|userName
init|=
operator|(
name|Literal
operator|)
name|inputGraph
operator|.
name|filter
argument_list|(
name|changeNode
argument_list|,
name|PLATFORM
operator|.
name|userName
argument_list|,
literal|null
argument_list|)
operator|.
name|next
argument_list|()
operator|.
name|getObject
argument_list|()
decl_stmt|;
name|NonLiteral
name|userNode
init|=
operator|(
name|NonLiteral
operator|)
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|PLATFORM
operator|.
name|userName
argument_list|,
name|userName
argument_list|)
operator|.
name|next
argument_list|()
operator|.
name|getSubject
argument_list|()
decl_stmt|;
name|UriRef
name|predicateUriRef
init|=
operator|(
name|UriRef
operator|)
name|inputGraph
operator|.
name|filter
argument_list|(
name|changeNode
argument_list|,
name|Ontology
operator|.
name|predicate
argument_list|,
literal|null
argument_list|)
operator|.
name|next
argument_list|()
operator|.
name|getObject
argument_list|()
decl_stmt|;
comment|// System.out.println("predicateUriRef = " + predicateUriRef);
comment|// handle old value (if it exists)
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|iterator
init|=
name|inputGraph
operator|.
name|filter
argument_list|(
name|changeNode
argument_list|,
name|Ontology
operator|.
name|oldValue
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|Resource
name|oldValue
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|iterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|oldValue
operator|=
name|iterator
operator|.
name|next
argument_list|()
operator|.
name|getObject
argument_list|()
expr_stmt|;
comment|// Triple oldTriple = systemGraph.filter(null, predicateUriRef,
comment|// oldValue).next();
name|Triple
name|oldTriple
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
name|userNode
argument_list|,
name|predicateUriRef
argument_list|,
name|oldValue
argument_list|)
operator|.
name|next
argument_list|()
decl_stmt|;
name|systemGraph
operator|.
name|remove
argument_list|(
name|oldTriple
argument_list|)
expr_stmt|;
block|}
name|Resource
name|newValue
init|=
name|inputGraph
operator|.
name|filter
argument_list|(
name|changeNode
argument_list|,
name|Ontology
operator|.
name|newValue
argument_list|,
literal|null
argument_list|)
operator|.
name|next
argument_list|()
operator|.
name|getObject
argument_list|()
decl_stmt|;
name|Triple
name|newTriple
init|=
operator|new
name|TripleImpl
argument_list|(
name|userNode
argument_list|,
name|predicateUriRef
argument_list|,
name|newValue
argument_list|)
decl_stmt|;
name|systemGraph
operator|.
name|add
argument_list|(
name|newTriple
argument_list|)
expr_stmt|;
block|}
comment|// it's not actually creating a resource at this URI so this
comment|// seems the most appropriate response
return|return
name|Response
operator|.
name|noContent
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
comment|/*      * Isn't very pretty but is just a one-off      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"user/{username}/rolesCheckboxes"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|Response
name|rolesCheckboxes
parameter_list|(
annotation|@
name|PathParam
argument_list|(
literal|"username"
argument_list|)
name|String
name|userName
parameter_list|)
block|{
comment|// return new RdfViewable("rolesCheckboxes", getRoleType(), this.getClass());
name|StringBuffer
name|html
init|=
operator|new
name|StringBuffer
argument_list|()
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|allRoleTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|RDF
operator|.
name|type
argument_list|,
name|PERMISSION
operator|.
name|Role
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|String
argument_list|>
name|allRoleNames
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
comment|// pulls out all role names
while|while
condition|(
name|allRoleTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|triple
init|=
name|allRoleTriples
operator|.
name|next
argument_list|()
decl_stmt|;
comment|//                if (triple.getPredicate().equals(DC.title)) {
comment|//                    allRoleNames.add(((Literal) triple.getObject()).getLexicalForm());
comment|//                    System.out.println("system role = "+((Literal) triple.getObject()).getLexicalForm());
comment|//                }
comment|//   NonLiteral roleNode = triple.getSubject();
name|GraphNode
name|roleNode
init|=
operator|new
name|GraphNode
argument_list|(
name|triple
operator|.
name|getSubject
argument_list|()
argument_list|,
name|systemGraph
argument_list|)
decl_stmt|;
name|Iterator
argument_list|<
name|Literal
argument_list|>
name|titlesIterator
init|=
name|roleNode
operator|.
name|getLiterals
argument_list|(
name|DC
operator|.
name|title
argument_list|)
decl_stmt|;
while|while
condition|(
name|titlesIterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|allRoleNames
operator|.
name|add
argument_list|(
name|titlesIterator
operator|.
name|next
argument_list|()
operator|.
name|getLexicalForm
argument_list|()
argument_list|)
expr_stmt|;
comment|//   System.out.println("system role = " + titlesIterator.next().getLexicalForm());
block|}
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
name|MGraph
name|rolesGraph
init|=
name|getUserRolesGraph
argument_list|(
name|userName
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|String
argument_list|>
name|userRoleNames
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|userRoleTriples
init|=
name|rolesGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|RDF
operator|.
name|type
argument_list|,
name|PERMISSION
operator|.
name|Role
argument_list|)
decl_stmt|;
while|while
condition|(
name|userRoleTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|triple
init|=
name|userRoleTriples
operator|.
name|next
argument_list|()
decl_stmt|;
name|GraphNode
name|roleNode
init|=
operator|new
name|GraphNode
argument_list|(
name|triple
operator|.
name|getSubject
argument_list|()
argument_list|,
name|rolesGraph
argument_list|)
decl_stmt|;
name|Iterator
argument_list|<
name|Literal
argument_list|>
name|titlesIterator
init|=
name|roleNode
operator|.
name|getLiterals
argument_list|(
name|DC
operator|.
name|title
argument_list|)
decl_stmt|;
while|while
condition|(
name|titlesIterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|userRoleNames
operator|.
name|add
argument_list|(
name|titlesIterator
operator|.
name|next
argument_list|()
operator|.
name|getLexicalForm
argument_list|()
argument_list|)
expr_stmt|;
comment|//   System.out.println("user role = " + titlesIterator.next().getLexicalForm());
block|}
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|allRoleNames
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
comment|// BasePermissionsRole
name|String
name|role
init|=
name|allRoleNames
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|role
operator|.
name|equals
argument_list|(
literal|"BasePermissionsRole"
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|userRoleNames
operator|.
name|contains
argument_list|(
name|role
argument_list|)
condition|)
block|{
name|html
operator|.
name|append
argument_list|(
literal|"<input class=\"role\" type=\"checkbox\" id=\""
operator|+
name|role
operator|+
literal|"\" name=\""
operator|+
name|role
operator|+
literal|"\" value=\""
operator|+
name|role
operator|+
literal|"\" checked=\"checked\" />"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|html
operator|.
name|append
argument_list|(
literal|"<input class=\"role\" type=\"checkbox\" id=\""
operator|+
name|role
operator|+
literal|"\" name=\""
operator|+
name|role
operator|+
literal|"\" value=\""
operator|+
name|role
operator|+
literal|"\" />"
argument_list|)
expr_stmt|;
block|}
name|html
operator|.
name|append
argument_list|(
literal|"<label for=\""
operator|+
name|role
operator|+
literal|"\">"
operator|+
name|role
operator|+
literal|"</label>"
argument_list|)
expr_stmt|;
name|html
operator|.
name|append
argument_list|(
literal|"<br />"
argument_list|)
expr_stmt|;
block|}
return|return
name|Response
operator|.
name|ok
argument_list|(
name|html
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**      * List the users. I.e. renders the user type with the "listUser" rendering      * specification.      *      * @return      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"users"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|RdfViewable
name|listUsers
parameter_list|()
block|{
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"listUser"
argument_list|,
name|getUserType
argument_list|()
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * Create a user. I.e. returns a dummy use with "editUSer" as rendering      * specification.      *      * @param uriInfo      * @return      */
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"create-form"
argument_list|)
specifier|public
name|RdfViewable
name|getCreateUserForm
parameter_list|(
annotation|@
name|Context
name|UriInfo
name|uriInfo
parameter_list|)
block|{
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"editUser"
argument_list|,
name|dummyNode
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * Endpoint-style user creation takes a little bunch of Turtle e.g. [] a      * foaf:Agent ; cz:userName "Hugo Ball" .      *      * [has test]      *      * @param userData      * @return HTTP/1.1 204 No Content      */
annotation|@
name|POST
comment|// @TODO add RESTful PUT version
annotation|@
name|Consumes
argument_list|(
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
annotation|@
name|Path
argument_list|(
literal|"add-user"
argument_list|)
specifier|public
name|Response
name|addUser
parameter_list|(
annotation|@
name|Context
name|UriInfo
name|uriInfo
parameter_list|,
name|String
name|userData
parameter_list|)
block|{
name|log
operator|.
name|debug
argument_list|(
operator|(
literal|"addUser called with "
operator|+
name|userData
operator|)
argument_list|)
expr_stmt|;
name|Graph
name|inputGraph
init|=
name|readData
argument_list|(
name|userData
argument_list|)
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|agents
init|=
name|inputGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|FOAF
operator|.
name|Agent
argument_list|)
decl_stmt|;
name|NonLiteral
name|userNode
init|=
name|agents
operator|.
name|next
argument_list|()
operator|.
name|getSubject
argument_list|()
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|userTriples
init|=
name|inputGraph
operator|.
name|filter
argument_list|(
name|userNode
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|String
name|userName
init|=
literal|""
decl_stmt|;
name|Triple
name|userTriple
init|=
literal|null
decl_stmt|;
name|Lock
name|writeLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|writeLock
argument_list|()
decl_stmt|;
name|writeLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
while|while
condition|(
name|userTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|userTriple
operator|=
name|userTriples
operator|.
name|next
argument_list|()
expr_stmt|;
name|systemGraph
operator|.
name|add
argument_list|(
name|userTriple
argument_list|)
expr_stmt|;
block|}
name|userName
operator|=
operator|(
operator|(
name|Literal
operator|)
name|userTriple
operator|.
name|getObject
argument_list|()
operator|)
operator|.
name|getLexicalForm
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|writeLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
name|UriBuilder
name|uriBuilder
init|=
name|uriInfo
operator|.
name|getBaseUriBuilder
argument_list|()
decl_stmt|;
name|URI
name|createdResource
init|=
literal|null
decl_stmt|;
comment|//    try {
comment|//  createdResource = new URI("http://localhost:8080/user-management/users/" + userName);
name|createdResource
operator|=
name|uriBuilder
operator|.
name|replacePath
argument_list|(
literal|"/user-management/users/"
operator|+
name|userName
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
comment|//        } catch (URISyntaxException ex) {
comment|//            java.util.logging.Logger.getLogger(UserResource.class.getName()).log(Level.SEVERE, null, ex);
comment|//        }
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"URI ="
operator|+
name|createdResource
argument_list|)
expr_stmt|;
comment|// from HTTPbis
comment|//The request has been fulfilled and has resulted in one or more new
comment|//   resources being created.
comment|//        Response.ResponseBuilder builder = Response.status(Response.Status.CREATED);
comment|//       // builder.header("Location", createdResource);
comment|//
comment|//        Response response = builder.build();
comment|//         MultivaluedMap<String,Object> meta = response.getMetadata();
comment|//         meta.putSingle("Location", createdResource);
return|return
name|Response
operator|.
name|created
argument_list|(
name|createdResource
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|// **********************************
comment|// ****** REMOVE USER ***************
comment|// **********************************
annotation|@
name|POST
annotation|@
name|Path
argument_list|(
literal|"delete"
argument_list|)
specifier|public
name|void
name|removeUser
parameter_list|(
annotation|@
name|FormParam
argument_list|(
literal|"user"
argument_list|)
name|String
name|userName
parameter_list|)
block|{
comment|// System.out.println("DELETE " + userName);
name|Resource
name|userResource
init|=
name|getNamedUser
argument_list|(
name|userName
argument_list|)
operator|.
name|getNode
argument_list|()
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|userTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
operator|(
name|NonLiteral
operator|)
name|userResource
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|Triple
argument_list|>
name|buffer
init|=
operator|new
name|ArrayList
argument_list|<
name|Triple
argument_list|>
argument_list|()
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
while|while
condition|(
name|userTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|triple
init|=
name|userTriples
operator|.
name|next
argument_list|()
decl_stmt|;
name|buffer
operator|.
name|add
argument_list|(
name|triple
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
comment|// Graph context = getNamedUser(userName).getNodeContext();
name|Lock
name|writeLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|writeLock
argument_list|()
decl_stmt|;
name|writeLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
name|systemGraph
operator|.
name|removeAll
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|writeLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Endpoint-style user deletion takes a little bunch of Turtle e.g. [] a      * foaf:Agent ; cz:userName "Hugo Ball" .      *      * @param userData      * @return HTTP/1.1 204 No Content      */
annotation|@
name|POST
annotation|@
name|Consumes
argument_list|(
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
annotation|@
name|Path
argument_list|(
literal|"delete-user"
argument_list|)
specifier|public
name|Response
name|deleteUser
parameter_list|(
name|String
name|userData
parameter_list|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"deleteUser called with "
operator|+
name|userData
argument_list|)
expr_stmt|;
name|Graph
name|inputGraph
init|=
name|readData
argument_list|(
name|userData
argument_list|)
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|userNameTriples
init|=
name|inputGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|PLATFORM
operator|.
name|userName
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|Literal
name|userNameNode
init|=
operator|(
name|Literal
operator|)
name|userNameTriples
operator|.
name|next
argument_list|()
operator|.
name|getObject
argument_list|()
decl_stmt|;
comment|// gives concurrent mod exception otherwise
name|ArrayList
argument_list|<
name|Triple
argument_list|>
name|tripleBuffer
init|=
operator|new
name|ArrayList
argument_list|<
name|Triple
argument_list|>
argument_list|()
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|userTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|userNameNode
argument_list|)
decl_stmt|;
name|Triple
name|userTriple
init|=
name|userTriples
operator|.
name|next
argument_list|()
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|systemUserTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
name|userTriple
operator|.
name|getSubject
argument_list|()
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
while|while
condition|(
name|systemUserTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|tripleBuffer
operator|.
name|add
argument_list|(
name|systemUserTriples
operator|.
name|next
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
name|systemGraph
operator|.
name|removeAll
argument_list|(
name|tripleBuffer
argument_list|)
expr_stmt|;
comment|// it's not actually creating a resource at this URI so this
comment|// seems the most appropriate response
return|return
name|Response
operator|.
name|noContent
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
comment|// **********************************
comment|// ****** SHOW ROLE DETAILS *********
comment|// **********************************
comment|// **********************************
comment|// ****** LIST ROLES ****************
comment|// **********************************
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"roles"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|RdfViewable
name|listRoles
parameter_list|()
block|{
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"listRole"
argument_list|,
name|getRoleType
argument_list|()
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|// **********************************
comment|// ****** ADD ROLE ******************
comment|// **********************************
comment|// **********************************
comment|// ****** REMOVE ROLE ***************
comment|// **********************************
comment|// **********************************
comment|// ****** ASSIGN ROLE TO USER *******
comment|// **********************************
comment|// **********************************
comment|// ****** REMOVE ROLE FROM USER *****
comment|// **********************************
comment|// **********************************
comment|// ****** LIST PERMISSIONS **********
comment|// **********************************
annotation|@
name|GET
annotation|@
name|Path
argument_list|(
literal|"permissions"
argument_list|)
annotation|@
name|Produces
argument_list|(
name|MediaType
operator|.
name|TEXT_HTML
argument_list|)
specifier|public
name|RdfViewable
name|listPermissions
parameter_list|()
block|{
name|addClassToPermissions
argument_list|()
expr_stmt|;
return|return
operator|new
name|RdfViewable
argument_list|(
literal|"listPermission"
argument_list|,
name|getPermissionType
argument_list|()
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
return|;
block|}
comment|// **********************************
comment|// ****** ADD PERMISSION TO USER ****
comment|// **********************************
comment|// **************************************
comment|// ****** REMOVE PERMISSION FROM USER ***
comment|// **************************************
comment|// ************************************
comment|// ****** ADD PERMISSION TO ROLE ******
comment|// ************************************
comment|// **************************************
comment|// ****** REMOVE PERMISSION FROM ROLE ***
comment|// **************************************
comment|// misc
annotation|@
name|GET
specifier|public
name|String
name|index
parameter_list|()
throws|throws
name|UnsupportedEncodingException
block|{
name|ByteArrayOutputStream
name|baos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|serializer
operator|.
name|serialize
argument_list|(
name|baos
argument_list|,
name|systemGraph
argument_list|,
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
expr_stmt|;
name|String
name|serialized
init|=
operator|new
name|String
argument_list|(
name|baos
operator|.
name|toByteArray
argument_list|()
argument_list|,
literal|"utf-8"
argument_list|)
decl_stmt|;
return|return
name|serialized
return|;
block|}
specifier|public
name|GraphNode
name|getUserType
parameter_list|()
block|{
return|return
operator|new
name|GraphNode
argument_list|(
name|FOAF
operator|.
name|Agent
argument_list|,
name|systemGraph
argument_list|)
return|;
block|}
comment|/**      * takes edit form data and pushes into store "" values are ignored      */
specifier|private
name|Response
name|store
parameter_list|(
name|GraphNode
name|userNode
parameter_list|,
name|UriInfo
name|uriInfo
parameter_list|,
name|String
name|currentUserName
parameter_list|,
name|String
name|newUserName
parameter_list|,
name|String
name|fullName
parameter_list|,
name|String
name|email
parameter_list|,
name|String
name|password
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|roles
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|permissions
parameter_list|)
block|{
comment|//   GraphNode userNode = getUser(currentUserName);
comment|// System.out.println("currentUserName = " + currentUserName);
comment|//        System.out
comment|//                .println("BEFORE ========================================================");
comment|//        // serializeTriplesWithSubject(System.out, userNode);
comment|//        serializer.serialize(System.out, systemGraph, SupportedFormat.TURTLE);
if|if
condition|(
name|newUserName
operator|!=
literal|null
operator|&&
operator|!
name|newUserName
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|changeLiteral
argument_list|(
name|userNode
argument_list|,
name|PLATFORM
operator|.
name|userName
argument_list|,
name|newUserName
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fullName
operator|!=
literal|null
operator|&&
operator|!
name|fullName
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|changeLiteral
argument_list|(
name|userNode
argument_list|,
name|FOAF
operator|.
name|name
argument_list|,
name|fullName
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|password
operator|!=
literal|null
operator|&&
operator|!
name|password
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|String
name|passwordSha1
init|=
name|PasswordUtil
operator|.
name|convertPassword
argument_list|(
name|password
argument_list|)
decl_stmt|;
name|changeLiteral
argument_list|(
name|userNode
argument_list|,
name|PERMISSION
operator|.
name|passwordSha1
argument_list|,
name|passwordSha1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|email
operator|!=
literal|null
operator|&&
operator|!
name|email
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|changeResource
argument_list|(
name|userNode
argument_list|,
name|FOAF
operator|.
name|mbox
argument_list|,
operator|new
name|UriRef
argument_list|(
literal|"mailto:"
operator|+
name|email
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|NonLiteral
name|userResource
init|=
operator|(
name|NonLiteral
operator|)
name|userNode
operator|.
name|getNode
argument_list|()
decl_stmt|;
if|if
condition|(
name|roles
operator|!=
literal|null
condition|)
block|{
name|clearRoles
argument_list|(
name|userResource
argument_list|)
expr_stmt|;
name|Lock
name|writeLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|writeLock
argument_list|()
decl_stmt|;
name|writeLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|roles
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|roles
operator|.
name|set
argument_list|(
name|i
argument_list|,
name|roles
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|roles
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|addRole
argument_list|(
name|userNode
argument_list|,
name|roles
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
name|writeLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|permissions
operator|!=
literal|null
condition|)
block|{
name|clearPermissions
argument_list|(
name|userResource
argument_list|)
expr_stmt|;
name|Lock
name|writeLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|writeLock
argument_list|()
decl_stmt|;
name|writeLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|permissions
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|permissions
operator|.
name|set
argument_list|(
name|i
argument_list|,
name|permissions
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|permissions
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|addPermission
argument_list|(
name|userNode
argument_list|,
name|permissions
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
name|writeLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
name|URI
name|pageUri
init|=
name|uriInfo
operator|.
name|getBaseUriBuilder
argument_list|()
operator|.
name|path
argument_list|(
literal|"system/console/usermanagement"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
comment|// header Cache-control: no-cache, just in case intermediaries are
comment|// holding onto old stuff
name|CacheControl
name|cc
init|=
operator|new
name|CacheControl
argument_list|()
decl_stmt|;
name|cc
operator|.
name|setNoCache
argument_list|(
literal|true
argument_list|)
expr_stmt|;
comment|// see other my not be the best response, but does seem the best given
comment|// the jax-rs things available
return|return
name|Response
operator|.
name|seeOther
argument_list|(
name|pageUri
argument_list|)
operator|.
name|cacheControl
argument_list|(
name|cc
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**      * NOT CURRENTLY IN USE replaces the subgraph      *<code>revokedString      *</code> with the one from      *<code>assertedString</code>.      *      * @param graphUri the graph within which the replacement has to take place      * or null for the content graph      * @param assertedString the asserted Graph      * @param revokedString the revoked Graph      * @param format the media-type of the rdf format in which the asserted and      * revoked graph are serialized, default: text/turtle      */
annotation|@
name|POST
annotation|@
name|Path
argument_list|(
literal|"replace-subgraph"
argument_list|)
annotation|@
name|Consumes
argument_list|(
name|MediaType
operator|.
name|MULTIPART_FORM_DATA
argument_list|)
specifier|public
name|void
name|replaceSubGraph
parameter_list|(
annotation|@
name|QueryParam
argument_list|(
literal|"graph"
argument_list|)
name|UriRef
name|graphUri
parameter_list|,
annotation|@
name|FormDataParam
argument_list|(
literal|"assert"
argument_list|)
name|String
name|assertedString
parameter_list|,
annotation|@
name|FormDataParam
argument_list|(
literal|"revoke"
argument_list|)
name|String
name|revokedString
parameter_list|,
annotation|@
name|FormDataParam
argument_list|(
literal|"format"
argument_list|)
annotation|@
name|DefaultValue
argument_list|(
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
name|String
name|format
parameter_list|)
block|{
specifier|final
name|Graph
name|assertedGraph
decl_stmt|;
specifier|final
name|Graph
name|revokedGraph
decl_stmt|;
try|try
block|{
name|assertedGraph
operator|=
name|parser
operator|.
name|parse
argument_list|(
operator|new
name|ByteArrayInputStream
argument_list|(
name|assertedString
operator|.
name|getBytes
argument_list|(
literal|"utf-8"
argument_list|)
argument_list|)
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|revokedGraph
operator|=
name|parser
operator|.
name|parse
argument_list|(
operator|new
name|ByteArrayInputStream
argument_list|(
name|assertedString
operator|.
name|getBytes
argument_list|(
literal|"utf-8"
argument_list|)
argument_list|)
argument_list|,
name|format
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ex
parameter_list|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"reading graph {}"
argument_list|,
name|ex
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|WebApplicationException
argument_list|(
name|ex
argument_list|,
literal|500
argument_list|)
throw|;
block|}
try|try
block|{
name|MGraphUtils
operator|.
name|removeSubGraph
argument_list|(
name|systemGraph
argument_list|,
name|revokedGraph
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NoSuchSubGraphException
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|ex
argument_list|)
throw|;
block|}
name|systemGraph
operator|.
name|addAll
argument_list|(
name|assertedGraph
argument_list|)
expr_stmt|;
block|}
specifier|public
name|GraphNode
name|getPermissionType
parameter_list|()
block|{
return|return
operator|new
name|GraphNode
argument_list|(
name|PERMISSION
operator|.
name|Permission
argument_list|,
name|systemGraph
argument_list|)
return|;
block|}
comment|/**      * a kludge - initially the permissions aren't expressed as instances of      * Permission class, this adds the relevant triples      */
specifier|private
name|void
name|addClassToPermissions
parameter_list|()
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|permissionTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|PERMISSION
operator|.
name|hasPermission
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|GraphNode
argument_list|>
name|buffer
init|=
operator|new
name|ArrayList
argument_list|<
name|GraphNode
argument_list|>
argument_list|()
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
while|while
condition|(
name|permissionTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|triple
init|=
name|permissionTriples
operator|.
name|next
argument_list|()
decl_stmt|;
name|Resource
name|permissionResource
init|=
name|triple
operator|.
name|getObject
argument_list|()
decl_stmt|;
name|buffer
operator|.
name|add
argument_list|(
operator|new
name|GraphNode
argument_list|(
name|permissionResource
argument_list|,
name|systemGraph
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
name|Lock
name|writeLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|writeLock
argument_list|()
decl_stmt|;
name|writeLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|buffer
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|buffer
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|addProperty
argument_list|(
name|RDF
operator|.
name|type
argument_list|,
name|PERMISSION
operator|.
name|Permission
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|writeLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
specifier|public
name|GraphNode
name|getRoleType
parameter_list|()
block|{
return|return
operator|new
name|GraphNode
argument_list|(
name|PERMISSION
operator|.
name|Role
argument_list|,
name|systemGraph
argument_list|)
return|;
block|}
specifier|private
name|MGraph
name|getUserRolesGraph
parameter_list|(
name|String
name|userName
parameter_list|)
block|{
name|GraphNode
name|userNode
init|=
name|getUser
argument_list|(
name|userName
argument_list|)
decl_stmt|;
name|Iterator
argument_list|<
name|Resource
argument_list|>
name|functionIterator
init|=
name|userNode
operator|.
name|getObjects
argument_list|(
name|SIOC
operator|.
name|has_function
argument_list|)
decl_stmt|;
name|SimpleMGraph
name|rolesGraph
init|=
operator|new
name|SimpleMGraph
argument_list|()
decl_stmt|;
while|while
condition|(
name|functionIterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|GraphNode
name|functionNode
init|=
operator|new
name|GraphNode
argument_list|(
name|functionIterator
operator|.
name|next
argument_list|()
argument_list|,
name|systemGraph
argument_list|)
decl_stmt|;
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|roleIterator
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
operator|(
name|NonLiteral
operator|)
name|functionNode
operator|.
name|getNode
argument_list|()
argument_list|,
name|RDF
operator|.
name|type
argument_list|,
name|PERMISSION
operator|.
name|Role
argument_list|)
decl_stmt|;
comment|// needs lock?
while|while
condition|(
name|roleIterator
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|roleTriple
init|=
name|roleIterator
operator|.
name|next
argument_list|()
decl_stmt|;
comment|// rolesGraph.add(roleTriple);
name|NonLiteral
name|roleNode
init|=
name|roleTriple
operator|.
name|getSubject
argument_list|()
decl_stmt|;
name|SimpleGraph
name|detailsGraph
init|=
operator|new
name|SimpleGraph
argument_list|(
name|systemGraph
operator|.
name|filter
argument_list|(
name|roleNode
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
decl_stmt|;
name|rolesGraph
operator|.
name|addAll
argument_list|(
name|detailsGraph
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|rolesGraph
return|;
block|}
comment|/**      * Creates a new user withe the specified user name      *      * @param newUserName      * @return      */
specifier|private
name|GraphNode
name|createUser
parameter_list|(
name|String
name|newUserName
parameter_list|)
block|{
name|BNode
name|subject
init|=
operator|new
name|BNode
argument_list|()
decl_stmt|;
name|GraphNode
name|userNode
init|=
operator|new
name|GraphNode
argument_list|(
name|subject
argument_list|,
name|systemGraph
argument_list|)
decl_stmt|;
name|userNode
operator|.
name|addProperty
argument_list|(
name|RDF
operator|.
name|type
argument_list|,
name|FOAF
operator|.
name|Agent
argument_list|)
expr_stmt|;
name|userNode
operator|.
name|addProperty
argument_list|(
name|PLATFORM
operator|.
name|userName
argument_list|,
operator|new
name|PlainLiteralImpl
argument_list|(
name|newUserName
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|userNode
return|;
block|}
comment|// move later?
specifier|public
specifier|final
specifier|static
name|String
name|rolesBase
init|=
literal|"urn:x-localhost/role/"
decl_stmt|;
specifier|private
name|void
name|clearRoles
parameter_list|(
name|NonLiteral
name|userResource
parameter_list|)
block|{
name|systemGraph
operator|.
name|removeAll
argument_list|(
name|filterToArray
argument_list|(
name|userResource
argument_list|,
name|SIOC
operator|.
name|has_function
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|private
name|ArrayList
argument_list|<
name|Triple
argument_list|>
name|filterToArray
parameter_list|(
name|NonLiteral
name|subject
parameter_list|,
name|UriRef
name|predicate
parameter_list|,
name|Resource
name|object
parameter_list|)
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|triples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
name|subject
argument_list|,
name|predicate
argument_list|,
name|object
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|Triple
argument_list|>
name|buffer
init|=
operator|new
name|ArrayList
argument_list|<
name|Triple
argument_list|>
argument_list|()
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
while|while
condition|(
name|triples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|buffer
operator|.
name|add
argument_list|(
name|triples
operator|.
name|next
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
return|return
name|buffer
return|;
block|}
specifier|private
name|GraphNode
name|addRole
parameter_list|(
name|GraphNode
name|userNode
parameter_list|,
name|String
name|roleName
parameter_list|)
block|{
comment|// System.out.println("ROLENAME = " + roleName);
comment|// is this thing already around? (will be a bnode)
name|GraphNode
name|roleNode
init|=
name|getTitleNode
argument_list|(
name|roleName
argument_list|)
decl_stmt|;
comment|// otherwise make a new one as a named node
if|if
condition|(
name|roleNode
operator|==
literal|null
condition|)
block|{
name|UriRef
name|roleUriRef
init|=
operator|new
name|UriRef
argument_list|(
name|rolesBase
operator|+
name|roleName
argument_list|)
decl_stmt|;
name|roleNode
operator|=
operator|new
name|GraphNode
argument_list|(
name|roleUriRef
argument_list|,
name|systemGraph
argument_list|)
expr_stmt|;
name|roleNode
operator|.
name|addProperty
argument_list|(
name|RDF
operator|.
name|type
argument_list|,
name|PERMISSION
operator|.
name|Role
argument_list|)
expr_stmt|;
name|roleNode
operator|.
name|addProperty
argument_list|(
name|DC
operator|.
name|title
argument_list|,
operator|new
name|PlainLiteralImpl
argument_list|(
name|roleName
argument_list|)
argument_list|)
expr_stmt|;
name|userNode
operator|.
name|addProperty
argument_list|(
name|SIOC
operator|.
name|has_function
argument_list|,
name|roleUriRef
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|userNode
operator|.
name|addProperty
argument_list|(
name|SIOC
operator|.
name|has_function
argument_list|,
name|roleNode
operator|.
name|getNode
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|userNode
return|;
block|}
specifier|public
specifier|final
specifier|static
name|String
name|permissionsBase
init|=
literal|"urn:x-localhost/role/"
decl_stmt|;
specifier|private
name|GraphNode
name|addPermission
parameter_list|(
name|GraphNode
name|userNode
parameter_list|,
name|String
name|permissionName
parameter_list|)
block|{
comment|// System.out.println("ROLENAME = " + roleName);
comment|// is this thing already around? (will be a bnode)
comment|//   GraphNode permissionNode = getTitleNode(permissionName);
comment|// otherwise make a new one as a named node
comment|//  if (permissionNode == null) {
comment|//            UriRef permissionUriRef = new UriRef(permissionsBase + permissionName);
comment|// BNode permissionBNode = new BNode();
name|GraphNode
name|permissionNode
init|=
operator|new
name|GraphNode
argument_list|(
operator|new
name|BNode
argument_list|()
argument_list|,
name|systemGraph
argument_list|)
decl_stmt|;
name|permissionNode
operator|.
name|addProperty
argument_list|(
name|RDF
operator|.
name|type
argument_list|,
name|PERMISSION
operator|.
name|Permission
argument_list|)
expr_stmt|;
comment|// permissionNode.addProperty(DC.title, new PlainLiteralImpl(permissionName));
name|userNode
operator|.
name|addProperty
argument_list|(
name|PERMISSION
operator|.
name|hasPermission
argument_list|,
name|permissionNode
operator|.
name|getNode
argument_list|()
argument_list|)
expr_stmt|;
name|permissionNode
operator|.
name|addProperty
argument_list|(
name|PERMISSION
operator|.
name|javaPermissionEntry
argument_list|,
operator|new
name|PlainLiteralImpl
argument_list|(
name|permissionName
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|userNode
return|;
block|}
comment|//    []    a<http://xmlns.com/foaf/0.1/Agent> ;
comment|//<http://clerezza.org/2008/10/permission#hasPermission>
comment|//              [ a<http://clerezza.org/2008/10/permission#Permission> ;
comment|//<http://clerezza.org/2008/10/permission#javaPermissionEntry>
comment|//                        "(java.security.AllPermission \"\" \"\")"
comment|//              ] ;
specifier|private
name|void
name|clearPermissions
parameter_list|(
name|NonLiteral
name|userResource
parameter_list|)
block|{
name|systemGraph
operator|.
name|removeAll
argument_list|(
name|filterToArray
argument_list|(
name|userResource
argument_list|,
name|PERMISSION
operator|.
name|javaPermissionEntry
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/*       * must be a neater way of doing this...      */
specifier|private
name|GraphNode
name|getTitleNode
parameter_list|(
name|String
name|title
parameter_list|)
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|triples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|DC
operator|.
name|title
argument_list|,
operator|new
name|PlainLiteralImpl
argument_list|(
name|title
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|triples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Resource
name|resource
init|=
name|triples
operator|.
name|next
argument_list|()
operator|.
name|getSubject
argument_list|()
decl_stmt|;
return|return
operator|new
name|GraphNode
argument_list|(
name|resource
argument_list|,
name|systemGraph
argument_list|)
return|;
block|}
return|return
literal|null
return|;
block|}
comment|/**      * Replaces/inserts literal value for predicate assumes there is only one      * triple for the given predicate new value is added before deleting old one      * in case user is modifying their own data in which case they need triples      * in place for rights etc.      *      * @param userNode node in systemGraph corresponding to the user to change      * @param predicate property of the triple to change      * @param newValue new value for given predicate      */
specifier|private
name|void
name|changeLiteral
parameter_list|(
name|GraphNode
name|userNode
parameter_list|,
name|UriRef
name|predicate
parameter_list|,
name|String
name|newValue
parameter_list|)
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|oldTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
operator|(
name|NonLiteral
operator|)
name|userNode
operator|.
name|getNode
argument_list|()
argument_list|,
name|predicate
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|Triple
argument_list|>
name|oldBuffer
init|=
operator|new
name|ArrayList
argument_list|<
name|Triple
argument_list|>
argument_list|()
decl_stmt|;
name|Resource
name|oldObject
init|=
literal|null
decl_stmt|;
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
while|while
condition|(
name|oldTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|triple
init|=
name|oldTriples
operator|.
name|next
argument_list|()
decl_stmt|;
name|oldObject
operator|=
name|triple
operator|.
name|getObject
argument_list|()
expr_stmt|;
name|oldBuffer
operator|.
name|add
argument_list|(
name|triple
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
comment|// filter appears to see plain literals and xsd:strings as differerent
comment|// so not
comment|// userNode.addPropertyValue(predicate, newValue);
name|PlainLiteral
name|newObject
init|=
operator|new
name|PlainLiteralImpl
argument_list|(
name|newValue
argument_list|)
decl_stmt|;
name|userNode
operator|.
name|addProperty
argument_list|(
name|predicate
argument_list|,
name|newObject
argument_list|)
expr_stmt|;
if|if
condition|(
name|newObject
operator|.
name|equals
argument_list|(
name|oldObject
argument_list|)
condition|)
block|{
return|return;
block|}
name|systemGraph
operator|.
name|removeAll
argument_list|(
name|oldBuffer
argument_list|)
expr_stmt|;
block|}
comment|/**      * Replaces/inserts resource value for predicate assumes there is only one      * triple for the given predicate      *      * @param userNode node in systemGraph corresponding to the user to change      * @param predicate property of the triple to change      * @param newValue new value for given predicate      */
specifier|private
name|void
name|changeResource
parameter_list|(
name|GraphNode
name|userNode
parameter_list|,
name|UriRef
name|predicate
parameter_list|,
name|UriRef
name|newValue
parameter_list|)
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|oldTriples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
operator|(
name|NonLiteral
operator|)
name|userNode
operator|.
name|getNode
argument_list|()
argument_list|,
name|predicate
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|ArrayList
argument_list|<
name|Triple
argument_list|>
name|oldBuffer
init|=
operator|new
name|ArrayList
argument_list|<
name|Triple
argument_list|>
argument_list|()
decl_stmt|;
comment|// System.out.println("\n\n");
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
while|while
condition|(
name|oldTriples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|Triple
name|triple
init|=
name|oldTriples
operator|.
name|next
argument_list|()
decl_stmt|;
name|Resource
name|oldValue
init|=
name|triple
operator|.
name|getObject
argument_list|()
decl_stmt|;
if|if
condition|(
name|newValue
operator|.
name|equals
argument_list|(
name|oldValue
argument_list|)
condition|)
block|{
return|return;
block|}
name|oldBuffer
operator|.
name|add
argument_list|(
name|triple
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
comment|// filter appears to see plain literals and xsd:strings as differerent
comment|// so not
comment|// userNode.addPropertyValue(predicate, newValue);
name|userNode
operator|.
name|addProperty
argument_list|(
name|predicate
argument_list|,
name|newValue
argument_list|)
expr_stmt|;
name|systemGraph
operator|.
name|removeAll
argument_list|(
name|oldBuffer
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|serializeTriplesWithSubject
parameter_list|(
name|OutputStream
name|stream
parameter_list|,
name|GraphNode
name|node
parameter_list|)
block|{
name|serializer
operator|.
name|serialize
argument_list|(
name|stream
argument_list|,
name|getTriplesWithSubject
argument_list|(
name|node
argument_list|)
argument_list|,
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
expr_stmt|;
block|}
specifier|private
name|TripleCollection
name|getTriplesWithSubject
parameter_list|(
name|GraphNode
name|node
parameter_list|)
block|{
name|TripleCollection
name|containerGraph
init|=
name|node
operator|.
name|getGraph
argument_list|()
decl_stmt|;
return|return
operator|new
name|SimpleGraph
argument_list|(
name|containerGraph
operator|.
name|filter
argument_list|(
operator|(
name|NonLiteral
operator|)
name|node
operator|.
name|getNode
argument_list|()
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
return|;
block|}
comment|/**      * Read string into graph      *      * @param data Turtle string      * @return graph from Turtle      */
specifier|private
name|Graph
name|readData
parameter_list|(
name|String
name|data
parameter_list|)
block|{
name|Graph
name|inputGraph
decl_stmt|;
try|try
block|{
name|inputGraph
operator|=
name|parser
operator|.
name|parse
argument_list|(
operator|new
name|ByteArrayInputStream
argument_list|(
name|data
operator|.
name|getBytes
argument_list|(
literal|"utf-8"
argument_list|)
argument_list|)
argument_list|,
name|SupportedFormat
operator|.
name|TURTLE
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ex
parameter_list|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"parsing error with userData"
argument_list|,
name|ex
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|WebApplicationException
argument_list|(
name|ex
argument_list|,
literal|500
argument_list|)
throw|;
block|}
return|return
name|inputGraph
return|;
block|}
specifier|private
name|GraphNode
name|getUser
parameter_list|(
annotation|@
name|QueryParam
argument_list|(
literal|"userName"
argument_list|)
name|String
name|userName
parameter_list|)
block|{
return|return
name|getNamedUser
argument_list|(
name|userName
argument_list|)
return|;
block|}
comment|/*      * returns an existing user node from the graph.      */
comment|// needs lock?
specifier|private
name|GraphNode
name|getNamedUser
parameter_list|(
name|String
name|userName
parameter_list|)
block|{
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|iter
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|PLATFORM
operator|.
name|userName
argument_list|,
operator|new
name|PlainLiteralImpl
argument_list|(
name|userName
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|iter
operator|.
name|hasNext
argument_list|()
condition|)
block|{
return|return
literal|null
return|;
block|}
return|return
operator|new
name|GraphNode
argument_list|(
name|iter
operator|.
name|next
argument_list|()
operator|.
name|getSubject
argument_list|()
argument_list|,
name|systemGraph
argument_list|)
return|;
block|}
specifier|public
name|Set
argument_list|<
name|GraphNode
argument_list|>
name|getUsers
parameter_list|()
block|{
return|return
name|getResourcesOfType
argument_list|(
name|FOAF
operator|.
name|Agent
argument_list|)
return|;
block|}
specifier|private
name|Set
argument_list|<
name|GraphNode
argument_list|>
name|getResourcesOfType
parameter_list|(
name|UriRef
name|type
parameter_list|)
block|{
name|Lock
name|readLock
init|=
name|systemGraph
operator|.
name|getLock
argument_list|()
operator|.
name|readLock
argument_list|()
decl_stmt|;
name|readLock
operator|.
name|lock
argument_list|()
expr_stmt|;
try|try
block|{
specifier|final
name|Iterator
argument_list|<
name|Triple
argument_list|>
name|triples
init|=
name|systemGraph
operator|.
name|filter
argument_list|(
literal|null
argument_list|,
name|RDF
operator|.
name|type
argument_list|,
name|type
argument_list|)
decl_stmt|;
name|Set
argument_list|<
name|GraphNode
argument_list|>
name|resources
init|=
operator|new
name|HashSet
argument_list|<
name|GraphNode
argument_list|>
argument_list|()
decl_stmt|;
while|while
condition|(
name|triples
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|resources
operator|.
name|add
argument_list|(
operator|new
name|GraphNode
argument_list|(
name|triples
operator|.
name|next
argument_list|()
operator|.
name|getSubject
argument_list|()
argument_list|,
name|systemGraph
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|resources
return|;
block|}
finally|finally
block|{
name|readLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

