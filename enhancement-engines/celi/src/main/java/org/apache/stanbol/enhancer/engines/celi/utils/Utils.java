begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/* * Licensed to the Apache Software Foundation (ASF) under one or more * contributor license agreements.  See the NOTICE file distributed with * this work for additional information regarding copyright ownership. * The ASF licenses this file to You under the Apache License, Version 2.0 * (the "License"); you may not use this file except in compliance with * the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|enhancer
operator|.
name|engines
operator|.
name|celi
operator|.
name|utils
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|HttpURLConnection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Dictionary
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|enhancer
operator|.
name|engines
operator|.
name|celi
operator|.
name|CeliConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|osgi
operator|.
name|framework
operator|.
name|BundleContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|osgi
operator|.
name|service
operator|.
name|cm
operator|.
name|ConfigurationException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_class
specifier|public
specifier|final
class|class
name|Utils
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|Utils
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
name|Utils
parameter_list|()
block|{}
comment|/**      * The maximum size of the preix/suffix for the selection context      */
specifier|private
specifier|static
specifier|final
name|int
name|DEFAULT_SELECTION_CONTEXT_PREFIX_SUFFIX_SIZE
init|=
literal|50
decl_stmt|;
comment|/**      * Extracts the selection context based on the content, selection and      * the start char offset of the selection      * @param content the content      * @param selection the selected text      * @param selectionStartPos the start char position of the selection      * @return the context      */
specifier|public
specifier|static
name|String
name|getSelectionContext
parameter_list|(
name|String
name|content
parameter_list|,
name|String
name|selection
parameter_list|,
name|int
name|selectionStartPos
parameter_list|)
block|{
comment|//extract the selection context
name|int
name|beginPos
decl_stmt|;
if|if
condition|(
name|selectionStartPos
operator|<=
name|DEFAULT_SELECTION_CONTEXT_PREFIX_SUFFIX_SIZE
condition|)
block|{
name|beginPos
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|int
name|start
init|=
name|selectionStartPos
operator|-
name|DEFAULT_SELECTION_CONTEXT_PREFIX_SUFFIX_SIZE
decl_stmt|;
name|beginPos
operator|=
name|content
operator|.
name|indexOf
argument_list|(
literal|' '
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|beginPos
operator|<
literal|0
operator|||
name|beginPos
operator|>=
name|selectionStartPos
condition|)
block|{
comment|//no words
name|beginPos
operator|=
name|start
expr_stmt|;
comment|//begin within a word
block|}
block|}
name|int
name|endPos
decl_stmt|;
if|if
condition|(
name|selectionStartPos
operator|+
name|selection
operator|.
name|length
argument_list|()
operator|+
name|DEFAULT_SELECTION_CONTEXT_PREFIX_SUFFIX_SIZE
operator|>=
name|content
operator|.
name|length
argument_list|()
condition|)
block|{
name|endPos
operator|=
name|content
operator|.
name|length
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|int
name|start
init|=
name|selectionStartPos
operator|+
name|selection
operator|.
name|length
argument_list|()
operator|+
name|DEFAULT_SELECTION_CONTEXT_PREFIX_SUFFIX_SIZE
decl_stmt|;
name|endPos
operator|=
name|content
operator|.
name|lastIndexOf
argument_list|(
literal|' '
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|endPos
operator|<=
name|selectionStartPos
operator|+
name|selection
operator|.
name|length
argument_list|()
condition|)
block|{
name|endPos
operator|=
name|start
expr_stmt|;
comment|//end within a word;
block|}
block|}
return|return
name|content
operator|.
name|substring
argument_list|(
name|beginPos
argument_list|,
name|endPos
argument_list|)
return|;
block|}
comment|/**      * Creates a POST Request with the parsed URL and optional headers      * @param serviceURL the service URL      * @param headers optional header      * @param conTimeout the connection timeout in seconds. If&lt;= 0 the default      * (30sec) is used.      * @return the HTTP connection      * @throws IOException if the connection to the parsed service could not be established.      * @throws IllegalArgumentException if<code>null</code> is parsed as service URL      */
specifier|public
specifier|static
name|HttpURLConnection
name|createPostRequest
parameter_list|(
name|URL
name|serviceURL
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|int
name|conTimeout
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|serviceURL
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"The parsed service URL MUST NOT be NULL!"
argument_list|)
throw|;
block|}
name|HttpURLConnection
name|urlConn
init|=
operator|(
name|HttpURLConnection
operator|)
name|serviceURL
operator|.
name|openConnection
argument_list|()
decl_stmt|;
name|urlConn
operator|.
name|setRequestMethod
argument_list|(
literal|"POST"
argument_list|)
expr_stmt|;
name|urlConn
operator|.
name|setDoInput
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|urlConn
operator|.
name|setDoOutput
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|urlConn
operator|.
name|setUseCaches
argument_list|(
literal|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|conTimeout
operator|<
literal|0
condition|)
block|{
name|conTimeout
operator|=
name|CeliConstants
operator|.
name|DEFAULT_CONECTION_TIMEOUT
expr_stmt|;
block|}
name|urlConn
operator|.
name|setConnectTimeout
argument_list|(
name|conTimeout
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|urlConn
operator|.
name|setReadTimeout
argument_list|(
name|conTimeout
operator|*
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|headers
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|entry
range|:
name|headers
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|urlConn
operator|.
name|setRequestProperty
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|,
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|urlConn
return|;
block|}
comment|/**      * Parses the {@link CeliConstants#CELI_LICENSE} form the configuration and      * the Environment. Also checks for {@link CeliConstants#CELI_TEST_ACCOUNT}      * if no license key is configured.      * @param configuration the configuration of the CELI engine      * @param ctx the {@link BundleContext} used to read the configuration of      * the environment.      * @return The license key or<code>null</code> if no license key is configured      * but<code>{@link CeliConstants#CELI_TEST_ACCOUNT}=true</code>.      * @throws ConfigurationException if no {@link CeliConstants#CELI_LICENSE}       * is configured and {@link CeliConstants#CELI_TEST_ACCOUNT} is not present      * or not set to<code>true</code>.      */
specifier|public
specifier|static
name|String
name|getLicenseKey
parameter_list|(
name|Dictionary
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|configuration
parameter_list|,
name|BundleContext
name|ctx
parameter_list|)
throws|throws
name|ConfigurationException
block|{
name|String
name|licenseKey
init|=
operator|(
name|String
operator|)
name|configuration
operator|.
name|get
argument_list|(
name|CeliConstants
operator|.
name|CELI_LICENSE
argument_list|)
decl_stmt|;
if|if
condition|(
name|licenseKey
operator|==
literal|null
operator|||
name|licenseKey
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|licenseKey
operator|=
name|ctx
operator|.
name|getProperty
argument_list|(
name|CeliConstants
operator|.
name|CELI_LICENSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|licenseKey
operator|==
literal|null
operator|||
name|licenseKey
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Object
name|value
init|=
name|configuration
operator|.
name|get
argument_list|(
name|CeliConstants
operator|.
name|CELI_TEST_ACCOUNT
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|null
condition|)
block|{
name|value
operator|=
name|ctx
operator|.
name|getProperty
argument_list|(
name|CeliConstants
operator|.
name|CELI_TEST_ACCOUNT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|==
literal|null
operator|||
operator|!
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ConfigurationException
argument_list|(
name|CeliConstants
operator|.
name|CELI_LICENSE
argument_list|,
literal|"The CELI License Key is a required configuration. To test the "
operator|+
literal|"CELI engines you can also activate the test account by setting '"
operator|+
name|CeliConstants
operator|.
name|CELI_TEST_ACCOUNT
operator|+
literal|"=true'. This account is limited "
operator|+
literal|"to 100 requests pre day and IP address."
argument_list|)
throw|;
block|}
else|else
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"no CELI license key configured for this Engine, a guest account will be used (max 100 requests per day). Go on http://linguagrid.org for getting a proper license key."
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|licenseKey
return|;
block|}
comment|/**      * Retrieves the connection timeout from the enignes configuration      * @param configuration the configuration of the CELI engine      * @param ctx the {@link BundleContext} used to read the configuration of      * the environment.      * @return The connection timeout or<code>-1</code> if none is configured      */
specifier|public
specifier|static
name|int
name|getConnectionTimeout
parameter_list|(
name|Dictionary
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|configuration
parameter_list|,
name|BundleContext
name|ctx
parameter_list|)
throws|throws
name|ConfigurationException
block|{
name|Object
name|value
init|=
name|configuration
operator|.
name|get
argument_list|(
name|CeliConstants
operator|.
name|CELI_CONNECTION_TIMEOUT
argument_list|)
decl_stmt|;
name|int
name|timeout
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|value
operator|instanceof
name|Number
condition|)
block|{
name|timeout
operator|=
operator|(
operator|(
name|Number
operator|)
name|value
operator|)
operator|.
name|intValue
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|timeout
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ConfigurationException
argument_list|(
name|CeliConstants
operator|.
name|CELI_CONNECTION_TIMEOUT
argument_list|,
literal|"The configured value '"
operator|+
name|value
operator|+
literal|"'is not a valid integer"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
name|value
operator|=
name|ctx
operator|.
name|getProperty
argument_list|(
name|CeliConstants
operator|.
name|CELI_TEST_ACCOUNT
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|timeout
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ConfigurationException
argument_list|(
name|CeliConstants
operator|.
name|CELI_CONNECTION_TIMEOUT
argument_list|,
literal|"The configured value '"
operator|+
name|value
operator|+
literal|"' taken from the system properties is not a valid integer"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
return|return
name|timeout
return|;
block|}
block|}
end_class

end_unit

