begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|entityhub
operator|.
name|indexing
operator|.
name|core
operator|.
name|source
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URLDecoder
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URLEncoder
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|NoSuchElementException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|entityhub
operator|.
name|indexing
operator|.
name|core
operator|.
name|EntityIterator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|entityhub
operator|.
name|indexing
operator|.
name|core
operator|.
name|config
operator|.
name|IndexingConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * Implementation of the {@link EntityIterator} based on reading data line wise  * from an {@link InputStream}  * @author Rupert Westenthaler  *  */
end_comment

begin_class
specifier|public
class|class
name|LineBasedEntityIterator
implements|implements
name|EntityIterator
block|{
comment|/**      * Parameter used to configure the position of the entity score (starting      * with 1)      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_SCORE_POS
init|=
literal|"score-pos"
decl_stmt|;
comment|/**      * Default position for the entity score=2      */
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_SCORE_POS
init|=
literal|2
decl_stmt|;
comment|/**      * Parameter used to configure the position of the entity id (starting      * with 1)      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_ID_POS
init|=
literal|"id-pos"
decl_stmt|;
comment|/**      * Default position for the entity id=1      */
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_ID_POS
init|=
literal|1
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_ID_NAMESPACE
init|=
literal|"id-namespace"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|LineBasedEntityIterator
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_SEPARATOR
init|=
literal|"separator"
decl_stmt|;
comment|/**      * The default separator to split the entity id with the score "\t" (tab)      */
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_SEPARATOR
init|=
literal|"\t"
decl_stmt|;
comment|/**      * The default encoding used to read the data from the parsed {@link InputStream}      * (UTF-8)      */
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_ENCODING
init|=
literal|"UTF-8"
decl_stmt|;
comment|/**      * Parameter used to configure the name of the source file within the      * {@link IndexingConfig#getSourceFolder()}      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_ENTITY_SCORE_FILE
init|=
literal|"source"
decl_stmt|;
comment|/**      * The default name used for the {@link #PARAM_ENTITY_SCORE_FILE}      */
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_ENTITY_SCORE_FILE
init|=
literal|"entityScores.tsv"
decl_stmt|;
comment|/**      * Parameter used to configure if the Entity IDs should be {@link URLEncoder      * URL encoded} (the default is {@value #DEFAULT_ENCODE_ENTITY_IDS})      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_URL_ENCODE_ENTITY_IDS
init|=
literal|"encodeIds"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_URL_DECODE_ENTITY_IDS
init|=
literal|"decodeIds"
decl_stmt|;
comment|/**      * Parameter used to configure the text encoding used by the source file      * (the default is {@value #DEFAULT_ENCODING})      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_CHARSET
init|=
literal|"charset"
decl_stmt|;
comment|/**      * Parameter used to configure if {@link String#trim()} should be called      * on lines.      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_TRIM_LINE
init|=
literal|"trimLine"
decl_stmt|;
comment|/**      * The default value for {@link #PARAM_TRIM_LINE} is<code>false</code>      */
specifier|public
specifier|static
specifier|final
name|boolean
name|DEFAULT_TRIM_LINE
init|=
literal|false
decl_stmt|;
comment|/**      * Parameter used to configure if {@link String#trim()} should be called      * on the element used to parse the entity id.      */
specifier|public
specifier|static
specifier|final
name|String
name|PARAM_TRIM_ID
init|=
literal|"trimEntity"
decl_stmt|;
comment|/**      * The default value vor {@link #DEFAULT_TRIM_ENTITY} is<code>true</code>      */
specifier|public
specifier|static
specifier|final
name|boolean
name|DEFAULT_TRIM_ENTITY
init|=
literal|true
decl_stmt|;
specifier|private
name|File
name|scoreFile
decl_stmt|;
specifier|private
name|BufferedReader
name|reader
decl_stmt|;
specifier|private
name|String
name|separator
decl_stmt|;
specifier|private
name|String
name|charset
decl_stmt|;
comment|/**      * Used to indicate if Entity IDs should be URL encoded/decoded<p>      *<source><pre>      * 0 ... no action      * -1 ... decode      * +1 ... encode      *</pre></source>      */
specifier|private
name|int
name|encodeEntityIds
decl_stmt|;
specifier|private
name|long
name|lineCounter
init|=
literal|0
decl_stmt|;
specifier|private
name|EntityScore
name|nextEntity
decl_stmt|;
specifier|private
name|int
name|scorePos
decl_stmt|;
specifier|private
name|int
name|idPos
decl_stmt|;
specifier|private
name|String
name|namespace
decl_stmt|;
specifier|private
name|boolean
name|trimLine
decl_stmt|;
specifier|private
name|boolean
name|trimEntityId
decl_stmt|;
comment|/**      * Default constructor relaying on {@link #setConfiguration(Map)} is used      * to provide the configuration      */
specifier|public
name|LineBasedEntityIterator
parameter_list|()
block|{
name|this
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
comment|/**      * Constructs an EntityScoreIterator that reads {@link EntityScore}s based       * on lines provided by the parsed InputStream.<p> Separator, Charset and      * encoding of Entity ids are initialised based on the default values.      * @param is the InputStream to read the data from      * @throws IOException On any error while initialising the {@link BufferedReader}      * based on the parsed {@link InputStream}      */
specifier|public
name|LineBasedEntityIterator
parameter_list|(
name|InputStream
name|is
parameter_list|)
block|{
name|this
argument_list|(
name|is
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
comment|/**      * Constructs an EntityScoreIterator based on the parsed parameters. The      * default values are used if<code>null</code> is parsed for any parameter      * other than the InputStream.      * @param is the InputStream to read the data from      * @param charset      * @param separator      * @throws IOException On any error while initialising the {@link BufferedReader}      * based on the parsed {@link InputStream}      * @throws IllegalArgumentException if<code>null</code> is parsed as InputStream      */
specifier|public
name|LineBasedEntityIterator
parameter_list|(
name|InputStream
name|is
parameter_list|,
name|String
name|charset
parameter_list|,
name|String
name|separator
parameter_list|)
throws|throws
name|IllegalArgumentException
block|{
if|if
condition|(
name|charset
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|charset
operator|=
name|DEFAULT_ENCODING
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|charset
operator|=
name|charset
expr_stmt|;
block|}
if|if
condition|(
name|separator
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|separator
operator|=
name|DEFAULT_SEPARATOR
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|separator
operator|=
name|separator
expr_stmt|;
block|}
if|if
condition|(
name|is
operator|!=
literal|null
condition|)
block|{
name|initReader
argument_list|(
name|is
argument_list|)
expr_stmt|;
block|}
name|scorePos
operator|=
name|DEFAULT_SCORE_POS
expr_stmt|;
name|idPos
operator|=
name|DEFAULT_ID_POS
expr_stmt|;
name|trimEntityId
operator|=
name|DEFAULT_TRIM_ENTITY
expr_stmt|;
name|trimLine
operator|=
name|DEFAULT_TRIM_LINE
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|setConfiguration
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|config
parameter_list|)
block|{
name|IndexingConfig
name|indexingConfig
init|=
operator|(
name|IndexingConfig
operator|)
name|config
operator|.
name|get
argument_list|(
name|IndexingConfig
operator|.
name|KEY_INDEXING_CONFIG
argument_list|)
decl_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Configure {} :"
argument_list|,
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|)
expr_stmt|;
name|Object
name|value
init|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_CHARSET
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
operator|&&
name|value
operator|.
name|toString
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|charset
operator|=
name|value
operator|.
name|toString
argument_list|()
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set charset to '{}'"
argument_list|,
name|charset
argument_list|)
expr_stmt|;
block|}
comment|//parse encode/decode EntityIDs
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_URL_ENCODE_ENTITY_IDS
argument_list|)
expr_stmt|;
name|boolean
name|encodeIds
decl_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
name|encodeIds
operator|=
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|.
name|containsKey
argument_list|(
name|PARAM_URL_ENCODE_ENTITY_IDS
argument_list|)
condition|)
block|{
name|encodeIds
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|encodeIds
operator|=
literal|false
expr_stmt|;
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_URL_DECODE_ENTITY_IDS
argument_list|)
expr_stmt|;
name|boolean
name|decodeIds
decl_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
name|decodeIds
operator|=
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|.
name|containsKey
argument_list|(
name|PARAM_URL_DECODE_ENTITY_IDS
argument_list|)
condition|)
block|{
name|decodeIds
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|decodeIds
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|encodeIds
operator|&&
name|decodeIds
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"One can not enable both Parameters '{}' and '{}'!"
argument_list|,
name|PARAM_URL_DECODE_ENTITY_IDS
argument_list|,
name|PARAM_URL_DECODE_ENTITY_IDS
argument_list|)
argument_list|)
throw|;
block|}
elseif|else
if|if
condition|(
name|encodeIds
condition|)
block|{
name|this
operator|.
name|encodeEntityIds
operator|=
literal|1
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"activate URL encoding of Entity IDs"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|decodeIds
condition|)
block|{
name|this
operator|.
name|encodeEntityIds
operator|=
operator|-
literal|1
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"activate URL decoding of Entity IDs"
argument_list|)
expr_stmt|;
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_ENTITY_SCORE_FILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|null
operator|||
name|value
operator|.
name|toString
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|scoreFile
operator|=
name|indexingConfig
operator|.
name|getSourceFile
argument_list|(
name|DEFAULT_ENTITY_SCORE_FILE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scoreFile
operator|=
name|indexingConfig
operator|.
name|getSourceFile
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|log
operator|.
name|info
argument_list|(
literal|"Set Source File to '"
operator|+
name|this
operator|.
name|scoreFile
operator|+
literal|"'"
argument_list|)
expr_stmt|;
comment|//now done in the initialise() method
comment|//        try {
comment|//            initReader(new FileInputStream(scoreFile));
comment|//        } catch (FileNotFoundException e) {
comment|//            throw new IllegalArgumentException("The File with the entity scores "+scoreFile.getAbsolutePath()+" does not exist",e);
comment|//        }
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_ID_POS
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|setIdPos
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Entity ID Position to '{}'"
argument_list|,
name|idPos
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Unable to parse the position of the entity id from "
operator|+
name|value
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_SCORE_POS
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|setScorePos
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Score Position to '{}'"
argument_list|,
name|scorePos
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Unable to parse the position of the entity score from "
operator|+
name|value
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
if|if
condition|(
name|idPos
operator|==
name|scorePos
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"The position of the ID and the Score "
operator|+
literal|"values MUST NOT be the same value "
operator|+
name|idPos
operator|+
literal|"! Use "
operator|+
name|PARAM_ID_POS
operator|+
literal|"(default="
operator|+
name|DEFAULT_ID_POS
operator|+
literal|") and "
operator|+
name|PARAM_SCORE_POS
operator|+
literal|"(default="
operator|+
name|DEFAULT_SCORE_POS
operator|+
literal|") to configure "
operator|+
literal|"other values than the defaults."
argument_list|)
throw|;
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_ID_NAMESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|namespace
operator|=
name|value
operator|.
name|toString
argument_list|()
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Namespace to ''"
argument_list|,
name|namespace
argument_list|)
expr_stmt|;
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_SEPARATOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
operator|&&
operator|!
name|value
operator|.
name|toString
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|this
operator|.
name|separator
operator|=
name|value
operator|.
name|toString
argument_list|()
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Separator to '{}'"
argument_list|,
name|separator
argument_list|)
expr_stmt|;
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_TRIM_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
name|trimLine
operator|=
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Trim Line State to '{}'"
argument_list|,
name|trimLine
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|.
name|containsKey
argument_list|(
name|PARAM_TRIM_LINE
argument_list|)
condition|)
block|{
comment|//also accept the key without value as TRUE
name|trimLine
operator|=
literal|true
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Trim Line State to '{}'"
argument_list|,
name|trimLine
argument_list|)
expr_stmt|;
block|}
name|value
operator|=
name|config
operator|.
name|get
argument_list|(
name|PARAM_TRIM_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
name|trimEntityId
operator|=
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|value
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Entity ID State to '{}'"
argument_list|,
name|trimEntityId
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|.
name|containsKey
argument_list|(
name|PARAM_TRIM_ID
argument_list|)
condition|)
block|{
comment|//also accept the key without value as TRUE
name|trimEntityId
operator|=
literal|true
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Set Entity ID State to '{}'"
argument_list|,
name|trimEntityId
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|setIdPos
parameter_list|(
name|int
name|idPos
parameter_list|)
block|{
if|if
condition|(
name|idPos
operator|<=
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"The position of the entity id MUST BE>= 1"
argument_list|)
throw|;
block|}
name|this
operator|.
name|idPos
operator|=
name|idPos
expr_stmt|;
block|}
specifier|private
name|void
name|setScorePos
parameter_list|(
name|int
name|scorePos
parameter_list|)
block|{
if|if
condition|(
name|scorePos
operator|<=
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"The position of the entity score MUST BE>= 1"
argument_list|)
throw|;
block|}
name|this
operator|.
name|scorePos
operator|=
name|scorePos
expr_stmt|;
block|}
comment|/**      * used by the constructors and {@link #setConfiguration(Map)} to initialise      * the reader based on the provided File/InputStream.      * @param is the input stream      * @param charset the charset      */
specifier|private
name|void
name|initReader
parameter_list|(
name|InputStream
name|is
parameter_list|)
block|{
try|try
block|{
name|reader
operator|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|InputStreamReader
argument_list|(
name|is
argument_list|,
name|this
operator|.
name|charset
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnsupportedEncodingException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"The parsed encoding "
operator|+
name|charset
operator|+
literal|" is not supported"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|hasNext
parameter_list|()
block|{
if|if
condition|(
name|nextEntity
operator|==
literal|null
condition|)
block|{
comment|//consumed or first or end reached
name|nextEntity
operator|=
name|getNext
argument_list|()
expr_stmt|;
comment|//search for the next
block|}
return|return
name|nextEntity
operator|!=
literal|null
return|;
comment|//return the found state
block|}
annotation|@
name|Override
specifier|public
name|EntityScore
name|next
parameter_list|()
block|{
name|EntityScore
name|entity
init|=
name|nextEntity
decl_stmt|;
name|nextEntity
operator|=
literal|null
expr_stmt|;
comment|//consume
if|if
condition|(
name|entity
operator|==
literal|null
condition|)
block|{
comment|//no next element (e.g. hasNext was not called)
name|entity
operator|=
name|getNext
argument_list|()
expr_stmt|;
comment|//search for it now
block|}
if|if
condition|(
name|entity
operator|==
literal|null
condition|)
block|{
comment|//if not found
throw|throw
operator|new
name|NoSuchElementException
argument_list|()
throw|;
block|}
return|return
name|entity
return|;
block|}
specifier|private
name|EntityScore
name|getNext
parameter_list|()
block|{
name|String
name|line
decl_stmt|;
try|try
block|{
while|while
condition|(
operator|(
name|line
operator|=
name|reader
operator|.
name|readLine
argument_list|()
operator|)
operator|!=
literal|null
condition|)
block|{
name|lineCounter
operator|++
expr_stmt|;
name|log
operator|.
name|debug
argument_list|(
literal|"> line = {}"
argument_list|)
expr_stmt|;
name|EntityScore
name|entity
init|=
name|parseEntityFormLine
argument_list|(
name|line
argument_list|)
decl_stmt|;
if|if
condition|(
name|entity
operator|!=
literal|null
condition|)
block|{
return|return
name|entity
return|;
block|}
block|}
return|return
literal|null
return|;
comment|//no more elements!
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Unable to read next EntityScore"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * @param line      * @return      */
specifier|private
name|EntityScore
name|parseEntityFormLine
parameter_list|(
name|String
name|line
parameter_list|)
block|{
if|if
condition|(
name|line
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
if|if
condition|(
name|trimLine
condition|)
block|{
name|line
operator|=
name|line
operator|.
name|trim
argument_list|()
expr_stmt|;
block|}
name|String
index|[]
name|parts
init|=
name|line
operator|.
name|split
argument_list|(
name|separator
argument_list|)
decl_stmt|;
name|String
name|entity
decl_stmt|;
name|Float
name|score
decl_stmt|;
if|if
condition|(
name|parts
operator|.
name|length
operator|>=
name|idPos
condition|)
block|{
try|try
block|{
name|String
name|value
decl_stmt|;
if|if
condition|(
name|trimEntityId
condition|)
block|{
name|value
operator|=
name|parts
index|[
name|idPos
operator|-
literal|1
index|]
operator|.
name|trim
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
name|parts
index|[
name|idPos
operator|-
literal|1
index|]
expr_stmt|;
block|}
name|String
name|id
decl_stmt|;
if|if
condition|(
name|encodeEntityIds
operator|>
literal|0
condition|)
block|{
name|id
operator|=
name|URLEncoder
operator|.
name|encode
argument_list|(
name|value
argument_list|,
literal|"UTF-8"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|encodeEntityIds
operator|<
literal|0
condition|)
block|{
name|id
operator|=
name|URLDecoder
operator|.
name|decode
argument_list|(
name|value
argument_list|,
literal|"UTF-8"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|id
operator|=
name|value
expr_stmt|;
block|}
name|log
operator|.
name|debug
argument_list|(
literal|" - id = {}"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|entity
operator|=
name|namespace
operator|!=
literal|null
condition|?
name|namespace
operator|+
name|id
else|:
name|id
expr_stmt|;
name|log
operator|.
name|debug
argument_list|(
literal|" - entity = {}"
argument_list|,
name|entity
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnsupportedEncodingException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Unable to URLEncode EntityIds"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
return|return
literal|null
return|;
comment|//No id -> no entity ...
block|}
if|if
condition|(
name|parts
operator|.
name|length
operator|>=
name|scorePos
condition|)
block|{
try|try
block|{
name|score
operator|=
name|Float
operator|.
name|parseFloat
argument_list|(
name|parts
index|[
name|scorePos
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Unable to parse the score for "
operator|+
literal|"Entity %s from value %s in line %s! Use NULL as score 0"
argument_list|,
name|entity
argument_list|,
name|parts
index|[
name|scorePos
operator|-
literal|1
index|]
argument_list|,
name|lineCounter
argument_list|)
argument_list|)
expr_stmt|;
name|score
operator|=
literal|null
expr_stmt|;
block|}
block|}
else|else
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"No score for Entity {} in line {}! Use NULL as score"
argument_list|,
name|parts
index|[
literal|0
index|]
argument_list|,
name|lineCounter
argument_list|)
expr_stmt|;
name|score
operator|=
literal|null
expr_stmt|;
block|}
name|log
operator|.
name|debug
argument_list|(
literal|" - score = "
argument_list|,
name|score
argument_list|)
expr_stmt|;
return|return
operator|new
name|EntityScore
argument_list|(
name|entity
argument_list|,
name|score
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|remove
parameter_list|()
block|{
throw|throw
operator|new
name|UnsupportedOperationException
argument_list|(
literal|"Removal form the EnityScore list is not supported"
argument_list|)
throw|;
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|needsInitialisation
parameter_list|()
block|{
return|return
name|reader
operator|==
literal|null
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|initialise
parameter_list|()
block|{
try|try
block|{
name|initReader
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|scoreFile
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"The file with the Entity Scores is missing"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|close
parameter_list|()
block|{
if|if
condition|(
name|reader
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|reader
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|//ignore
block|}
block|}
block|}
block|}
end_class

end_unit

