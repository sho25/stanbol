begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|core
operator|.
name|mapping
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jcr
operator|.
name|RepositoryException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Activate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Component
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Reference
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|felix
operator|.
name|scr
operator|.
name|annotations
operator|.
name|Service
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|core
operator|.
name|decorated
operator|.
name|DObjectFactoryImp
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|jcr
operator|.
name|processor
operator|.
name|ConceptBridgesProcesser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|jcr
operator|.
name|processor
operator|.
name|InstanceBridgesProcesser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|jcr
operator|.
name|processor
operator|.
name|JCRNodeTypeLifter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|jcr
operator|.
name|processor
operator|.
name|SubsumptionBridgesProcesser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|helper
operator|.
name|OntologyResourceHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|mapping
operator|.
name|MappingEngine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|mapping
operator|.
name|NamingStrategy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|model
operator|.
name|mapping
operator|.
name|BridgeDefinitions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|model
operator|.
name|web
operator|.
name|ConnectionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|model
operator|.
name|web
operator|.
name|CMSObject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|model
operator|.
name|web
operator|.
name|decorated
operator|.
name|DObjectAdapter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|repository
operator|.
name|RepositoryAccess
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|repository
operator|.
name|RepositoryAccessException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|cmsadapter
operator|.
name|servicesapi
operator|.
name|repository
operator|.
name|RepositoryAccessManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|stanbol
operator|.
name|ontologymanager
operator|.
name|store
operator|.
name|rest
operator|.
name|client
operator|.
name|RestClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|hp
operator|.
name|hpl
operator|.
name|jena
operator|.
name|ontology
operator|.
name|OntModel
import|;
end_import

begin_import
import|import
name|com
operator|.
name|hp
operator|.
name|hpl
operator|.
name|jena
operator|.
name|ontology
operator|.
name|OntModelSpec
import|;
end_import

begin_import
import|import
name|com
operator|.
name|hp
operator|.
name|hpl
operator|.
name|jena
operator|.
name|rdf
operator|.
name|model
operator|.
name|ModelFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|hp
operator|.
name|hpl
operator|.
name|jena
operator|.
name|rdf
operator|.
name|model
operator|.
name|RDFWriter
import|;
end_import

begin_class
annotation|@
name|Component
argument_list|(
name|factory
operator|=
literal|"org.apache.stanbol.cmsadapter.servicesapi.mapping.MappingEngineFactory"
argument_list|)
annotation|@
name|Service
specifier|public
class|class
name|MappingEngineImpl
implements|implements
name|MappingEngine
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|logger
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|MappingEngineImpl
operator|.
name|class
argument_list|)
decl_stmt|;
comment|/*      * public static final String PROPERTY_ONTOLOGY_URI = "ontology.uri"; public static final String      * PROPERTY_CONNECTION_INFO = "connection.info";      *       * @Property(name = PROPERTY_ONTOLOGY_URI) private String ontologyURI;      *       * @Property(name = PROPERTY_CONNECTION_INFO) private ConnectionInfo connectionInfo;      */
annotation|@
name|Reference
specifier|private
name|RestClient
name|storeClient
decl_stmt|;
annotation|@
name|Reference
specifier|private
name|RepositoryAccessManager
name|accessManager
decl_stmt|;
specifier|private
name|Object
name|session
decl_stmt|;
specifier|private
name|OntModel
name|ontModel
decl_stmt|;
specifier|private
name|String
name|ontologyURI
decl_stmt|;
specifier|private
name|BridgeDefinitions
name|bridgeDefinitions
decl_stmt|;
specifier|private
name|OntologyResourceHelper
name|ontologyResourceHelper
decl_stmt|;
specifier|private
name|DObjectAdapter
name|adapter
decl_stmt|;
specifier|private
name|NamingStrategy
name|namingStrategy
decl_stmt|;
specifier|public
name|MappingEngineImpl
parameter_list|()
block|{      }
annotation|@
name|Activate
specifier|public
name|void
name|activate
parameter_list|(
specifier|final
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
name|properties
parameter_list|)
block|{      }
specifier|public
name|Object
name|getSession
parameter_list|()
block|{
return|return
name|session
return|;
block|}
specifier|public
name|OntModel
name|getOntModel
parameter_list|()
block|{
return|return
name|ontModel
return|;
block|}
specifier|public
name|BridgeDefinitions
name|getBridgeDefinitions
parameter_list|()
block|{
return|return
name|bridgeDefinitions
return|;
block|}
specifier|public
name|OntologyResourceHelper
name|getOntologyResourceHelper
parameter_list|()
block|{
return|return
name|ontologyResourceHelper
return|;
block|}
specifier|public
name|String
name|getOntologyURI
parameter_list|()
block|{
return|return
name|ontologyURI
return|;
block|}
annotation|@
name|Override
specifier|public
name|NamingStrategy
name|getNamingStrategy
parameter_list|()
block|{
return|return
name|namingStrategy
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|mapCR
parameter_list|(
name|OntModel
name|model
parameter_list|,
name|String
name|ontologyURI
parameter_list|,
name|List
argument_list|<
name|CMSObject
argument_list|>
name|cmsObjects
parameter_list|)
throws|throws
name|RepositoryAccessException
block|{
name|ConnectionInfo
name|connectionInfo
init|=
name|OntologyResourceHelper
operator|.
name|getConnectionInfo
argument_list|(
name|model
argument_list|)
decl_stmt|;
name|RepositoryAccess
name|accessor
init|=
name|accessManager
operator|.
name|getRepositoryAccessor
argument_list|(
name|connectionInfo
argument_list|)
decl_stmt|;
name|this
operator|.
name|session
operator|=
name|accessor
operator|.
name|getSession
argument_list|(
name|connectionInfo
argument_list|)
expr_stmt|;
name|this
operator|.
name|bridgeDefinitions
operator|=
name|OntologyResourceHelper
operator|.
name|getBridgeDefinitions
argument_list|(
name|model
argument_list|)
expr_stmt|;
name|this
operator|.
name|ontologyURI
operator|=
name|ontologyURI
expr_stmt|;
name|this
operator|.
name|ontModel
operator|=
name|model
expr_stmt|;
name|this
operator|.
name|namingStrategy
operator|=
operator|new
name|DefaultNamingStrategy
argument_list|(
name|accessor
argument_list|,
name|session
argument_list|,
name|ontModel
argument_list|)
expr_stmt|;
name|this
operator|.
name|ontologyResourceHelper
operator|=
operator|new
name|OntologyResourceHelper
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|this
operator|.
name|adapter
operator|=
operator|new
name|DObjectFactoryImp
argument_list|(
name|accessor
argument_list|,
name|session
argument_list|)
expr_stmt|;
name|long
name|t1
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
operator|new
name|ConceptBridgesProcesser
argument_list|(
name|this
argument_list|)
operator|.
name|processUpdates
argument_list|(
name|cmsObjects
argument_list|)
expr_stmt|;
operator|new
name|SubsumptionBridgesProcesser
argument_list|(
name|this
argument_list|)
operator|.
name|processUpdates
argument_list|(
name|cmsObjects
argument_list|)
expr_stmt|;
operator|new
name|InstanceBridgesProcesser
argument_list|(
name|this
argument_list|)
operator|.
name|processUpdates
argument_list|(
name|cmsObjects
argument_list|)
expr_stmt|;
name|logger
operator|.
name|debug
argument_list|(
literal|"Total process time for ontology {} is {} ms"
argument_list|,
name|ontologyURI
argument_list|,
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|t1
argument_list|)
expr_stmt|;
try|try
block|{
name|ByteArrayOutputStream
name|bos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|RDFWriter
name|rdfWriter
init|=
name|ontModel
operator|.
name|getWriter
argument_list|(
literal|"RDF/XML"
argument_list|)
decl_stmt|;
name|rdfWriter
operator|.
name|setProperty
argument_list|(
literal|"xmlbase"
argument_list|,
name|ontologyURI
argument_list|)
expr_stmt|;
name|rdfWriter
operator|.
name|write
argument_list|(
name|ontModel
argument_list|,
name|bos
argument_list|,
name|ontologyURI
argument_list|)
expr_stmt|;
name|byte
index|[]
name|ontologyContentAsByteArray
init|=
name|bos
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|String
name|ontologyContentAsString
init|=
operator|new
name|String
argument_list|(
name|ontologyContentAsByteArray
argument_list|)
decl_stmt|;
name|storeClient
operator|.
name|saveOntology
argument_list|(
name|ontologyContentAsString
argument_list|,
name|ontologyURI
argument_list|,
literal|"UTF-8"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|logger
operator|.
name|error
argument_list|(
literal|"Exception occurred while saving the ontology"
argument_list|)
expr_stmt|;
name|logger
operator|.
name|error
argument_list|(
name|ex
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
comment|// TODO return error message to flex side
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|mapCR
parameter_list|(
name|BridgeDefinitions
name|bridges
parameter_list|,
name|ConnectionInfo
name|connectionInfo
parameter_list|,
name|String
name|ontologyURI
parameter_list|)
throws|throws
name|RepositoryAccessException
block|{
name|RepositoryAccess
name|accessor
init|=
name|accessManager
operator|.
name|getRepositoryAccessor
argument_list|(
name|connectionInfo
argument_list|)
decl_stmt|;
name|this
operator|.
name|session
operator|=
name|accessor
operator|.
name|getSession
argument_list|(
name|connectionInfo
argument_list|)
expr_stmt|;
name|this
operator|.
name|bridgeDefinitions
operator|=
name|bridges
expr_stmt|;
name|this
operator|.
name|ontologyURI
operator|=
name|ontologyURI
expr_stmt|;
name|this
operator|.
name|ontModel
operator|=
name|ModelFactory
operator|.
name|createOntologyModel
argument_list|(
name|OntModelSpec
operator|.
name|OWL_DL_MEM
argument_list|)
expr_stmt|;
name|this
operator|.
name|namingStrategy
operator|=
operator|new
name|DefaultNamingStrategy
argument_list|(
name|accessor
argument_list|,
name|session
argument_list|,
name|ontModel
argument_list|)
expr_stmt|;
name|this
operator|.
name|ontologyResourceHelper
operator|=
operator|new
name|OntologyResourceHelper
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|this
operator|.
name|adapter
operator|=
operator|new
name|DObjectFactoryImp
argument_list|(
name|accessor
argument_list|,
name|session
argument_list|)
expr_stmt|;
name|long
name|t1
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
try|try
block|{
operator|new
name|JCRNodeTypeLifter
argument_list|(
name|this
argument_list|)
operator|.
name|lift
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|RepositoryException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|error
argument_list|(
literal|"Lifting error"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
comment|// TODO Currently there are only JCR Processors
operator|new
name|ConceptBridgesProcesser
argument_list|(
name|this
argument_list|)
operator|.
name|processBridges
argument_list|()
expr_stmt|;
comment|// Processing SubsumptionBridges
operator|new
name|SubsumptionBridgesProcesser
argument_list|(
name|this
argument_list|)
operator|.
name|processBridges
argument_list|()
expr_stmt|;
comment|// Processing InstanceBridges
operator|new
name|InstanceBridgesProcesser
argument_list|(
name|this
argument_list|)
operator|.
name|processBridges
argument_list|()
expr_stmt|;
comment|// save connection info
name|OntologyResourceHelper
operator|.
name|saveConnectionInfo
argument_list|(
name|connectionInfo
argument_list|,
name|ontModel
argument_list|)
expr_stmt|;
comment|// save bridge definitions
comment|// deserialize
name|OntologyResourceHelper
operator|.
name|saveBridgeDefinitions
argument_list|(
name|bridgeDefinitions
argument_list|,
name|ontModel
argument_list|)
expr_stmt|;
name|ByteArrayOutputStream
name|bos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|logger
operator|.
name|debug
argument_list|(
literal|"Total process time for ontology {} is {} ms"
argument_list|,
name|ontologyURI
argument_list|,
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|t1
argument_list|)
expr_stmt|;
try|try
block|{
name|RDFWriter
name|rdfWriter
init|=
name|ontModel
operator|.
name|getWriter
argument_list|(
literal|"RDF/XML"
argument_list|)
decl_stmt|;
name|rdfWriter
operator|.
name|setProperty
argument_list|(
literal|"xmlbase"
argument_list|,
name|ontologyURI
argument_list|)
expr_stmt|;
name|rdfWriter
operator|.
name|write
argument_list|(
name|ontModel
argument_list|,
name|bos
argument_list|,
name|ontologyURI
argument_list|)
expr_stmt|;
name|byte
index|[]
name|ontologyContentAsByteArray
init|=
name|bos
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|String
name|ontologyContentAsString
init|=
operator|new
name|String
argument_list|(
name|ontologyContentAsByteArray
argument_list|)
decl_stmt|;
name|storeClient
operator|.
name|saveOntology
argument_list|(
name|ontologyContentAsString
argument_list|,
name|ontologyURI
argument_list|,
literal|"UTF-8"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|logger
operator|.
name|error
argument_list|(
literal|"Exception occurred while saving the ontology"
argument_list|)
expr_stmt|;
name|logger
operator|.
name|error
argument_list|(
name|ex
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
comment|// TODO return error message to flex side
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|liftNodeTypes
parameter_list|(
name|ConnectionInfo
name|connectionInfo
parameter_list|,
name|String
name|ontologyURI
parameter_list|)
block|{
comment|// TODO Auto-generated method stub
block|}
annotation|@
name|Override
specifier|public
name|RepositoryAccessManager
name|getRepositoryAccessManager
parameter_list|()
block|{
return|return
name|accessManager
return|;
block|}
annotation|@
name|Override
specifier|public
name|DObjectAdapter
name|getDObjectAdapter
parameter_list|()
block|{
return|return
name|adapter
return|;
block|}
block|}
end_class

end_unit

